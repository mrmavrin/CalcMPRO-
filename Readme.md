# Описание проекта CalcMProLib

## 1. Общая структура проекта

## 2. Назначение и функциональность

Библиотека CalcMProLib предназначена для работы с блочной структурой данных в Google Таблицах и предоставляет:

- Набор пользовательских функций для расчета данных в блоках
- Механизм сохранения и восстановления данных
- Пользовательский интерфейс через меню Google Sheets
- Работу с несколькими взаимосвязанными таблицами

## 3. Ключевые файлы и их функциональность

### 3.1. code.js - Главный файл библиотеки

**Назначение:** Точка входа, инициализирует все компоненты и экспортирует API.

**Структура:**
- Глобальные переменные `FormulasLib`, `ReestrOffersLib`, `UI`
- Функция `init()` для инициализации библиотеки
- Функция `onOpen()` для создания меню при открытии таблицы
- Экспорт функций библиотеки через `this.*`
- Функции для работы с меню

**Ключевые экспортируемые функции:**
- `FLAG_CHECK`
- `MY_CUSTOM_FUNC`
- `SUPPLIER_ARTICLE`
- `UNIT_MEASURE`
- `SUM_PRODUCT_ARR`
- `PHOTO_ARRAY`
- `SPECIFICATION_WITH_LINK`
- `CODE_MS`
- `CHECK_QUANTITY`
- `CALCULATE_PRICE_DYNAMIC`
- `XBLOCK`

**Проблемные места в code.js:**
1. Строка 45: `this.XBLOCK = XBLOCK;` - XBLOCK не определен в текущей области видимости
2. Строки 111-114: Рекурсивный вызов `restoreByIdWithConfirm`, создающий бесконечный цикл

### 3.2. FormulasLib.js - Библиотека формул

**Назначение:** Содержит формулы для вычислений в таблицах.

**Ключевые функции:**
- `FLAG_CHECK` - Проверка флага для строки
- `MY_CUSTOM_FUNC` - Кастомная функция для расчетов
- `SUPPLIER_ARTICLE` - Извлечение артикула поставщика
- `UNIT_MEASURE` - Получение единицы измерения
- `SUM_PRODUCT_ARR` - Функция для суммирования произведений массивов
- `SPECIFICATION_WITH_LINK` - Создание спецификации с гиперссылками
- `init()` - Инициализация с настройками

### 3.3. ReestrOffersLib.js - Реестр предложений

**Назначение:** Управляет сохранением и восстановлением данных.

**Ключевые функции:**
- `saveDataWithComment()` - Сохранение данных с комментариями
- `showRestoreDialog()` - Показ диалога восстановления
- `restoreByIdWithConfirm(id)` - Восстановление данных по ID

### 3.4. UI.js - Пользовательский интерфейс

**Назначение:** Управляет элементами UI и диалогами.

**Ключевые функции:**
- `createMenu()` - Создание меню в таблице
- `showConfigDialog()` - Диалог настроек
- `showInfoDialog()` - Информационный диалог

### 3.5. blocks.js - Работа с блоками

**Назначение:** Обработка блочной структуры данных.

**Ключевые функции:**
- `XBLOCK()` - Обработка указанного блока данных
- Вспомогательные функции для обработки блоков

## 4. Структура данных в таблицах

- Формат именования листов блоков: "Лист{blockNum}.0", где blockNum - номер от 1 до 14
- Служебные листы: 
  - "НАЦЕНКИ" - информация о наценках
  - "МодельСМЕТЫ" - основной шаблон смет

**Ключевые диапазоны данных:**
- A3:A38 - Используется в MY_CUSTOM_FUNC
- D3:D38 - Содержит артикулы, используется во многих функциях
- E3:E38 - Количества товаров
- G3:G38 - Стоимость за единицу
- I2 - Наценка
- I3:I38 - Дополнительные значения для расчета цен
- F1:V - Диапазон данных для SPECIFICATION_WITH_LINK

## 5. Проблемы и особенности

### 5.1. Проблема с функцией "Открыть данные"

Пользователи с правами редактора не могут использовать функцию "Открыть данные". Причина:
- В диалоге восстановления используется вызов `google.script.run.restoreByIdWithConfirm(id)`
- Для корректной работы функция `restoreByIdWithConfirm` должна быть доступна в глобальном пространстве имен
- В коде есть проблема с этой функцией, которая создает рекурсию

### 5.2. Особенности работы с CLASP

- Для деплоя изменений используется команда `clasp push`
- Необходимо корректно настроить файл `.claspignore` для избирательной отправки файлов
- Требуется правильный ID скрипта в файле `.clasp.json`

## 6. UserScript.js - Скрипт для пользователей

**Назначение:** Добавляется в пользовательскую таблицу для подключения к библиотеке.

**Ключевые компоненты:**
- Функция `onOpen()` для создания меню
- Функции-обертки для формул библиотеки без префикса
- Должен содержать функцию `restoreByIdWithConfirm(id)` для корректной работы диалогов

## 7. Рекомендации для безопасного использования библиотеки

1. В файле `code.js` исправить ошибку с XBLOCK:
   ```javascript
   // Было:
   this.XBLOCK = XBLOCK;
   // Должно быть:
   this.XBLOCK = FormulasLib.XBLOCK; // или правильный источник
   ```
